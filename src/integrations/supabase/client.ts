
// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';
import type { User } from '@supabase/supabase-js';

const SUPABASE_URL = "https://sjzbturfgadikgzokpyo.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqemJ0dXJmZ2FkaWtnem9rcHlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxOTg4OTEsImV4cCI6MjA2Mjc3NDg5MX0.kK73WOJU9iCeSnGuHpcxIAWmxNGfQL8h7h6scXthF_I";

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
  auth: {
    storage: localStorage,
    persistSession: true,
    autoRefreshToken: true,
  }
});

// Create a script to create the super admin user
export const createSuperAdmin = async (password: string) => {
  const email = "super@edufar.co";

  try {
    // First, check if the user already exists using signIn to avoid permissions issues
    const { data: signInData, error: signInError } = await supabase.auth.signInWithPassword({
      email,
      password
    });

    // If sign in succeeds, user exists already
    if (signInData?.user) {
      return { success: true, message: 'Super admin already exists and credentials are valid' };
    }

    // If sign in fails for a reason other than "Invalid login credentials", handle that error
    if (signInError && !signInError.message.includes('Invalid login credentials')) {
      console.error('Error checking existing user:', signInError);
      throw signInError;
    }

    // At this point, we know the user doesn't exist or has invalid credentials
    // Try to create the super admin user
    const { data: authData, error: authError } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: {
          first_name: 'Super',
          last_name: 'Admin',
          role: 'super_admin'
        }
      }
    });

    if (authError) {
      if (authError.message.includes('already registered')) {
        return { success: false, message: 'Super admin exists but the password is incorrect' };
      }
      throw authError;
    }

    // The handle_new_user trigger will create the profile, but we need to update the role
    if (authData.user) {
      // Wait a moment for the trigger to create the profile
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // Direct database update to ensure the role is set to super_admin
      const { error: updateError } = await supabase
        .from('profiles')
        .update({ 
          role: 'super_admin', 
          school_id: '00000000-0000-0000-0000-000000000001' 
        })
        .eq('id', authData.user.id);

      if (updateError) {
        console.error('Error updating profile:', updateError);
        throw updateError;
      }

      return { success: true, message: 'Super admin created successfully' };
    }

    return { success: false, message: 'Failed to create super admin' };
    
  } catch (error: any) {
    console.error('Super admin creation error:', error);
    return { success: false, message: error.message || 'An unknown error occurred' };
  }
};
